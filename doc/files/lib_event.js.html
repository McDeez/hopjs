<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib&#x2F;event.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.1&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.5.1&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/Hop.html">Hop</a></li>
            
                <li><a href="..&#x2F;classes/Hop.CodeGenerator.html">Hop.CodeGenerator</a></li>
            
                <li><a href="..&#x2F;classes/Hop.Method.html">Hop.Method</a></li>
            
                <li><a href="..&#x2F;classes/Hop.Object.html">Hop.Object</a></li>
            
                <li><a href="..&#x2F;classes/Hop.StubRequest.html">Hop.StubRequest</a></li>
            
                <li><a href="..&#x2F;classes/Hop.StubResponse.html">Hop.StubResponse</a></li>
            
                <li><a href="..&#x2F;classes/Hop.TestCase.html">Hop.TestCase</a></li>
            
                <li><a href="..&#x2F;classes/Hop.TestTask.html">Hop.TestTask</a></li>
            
                <li><a href="..&#x2F;classes/Hop.TestUtils.html">Hop.TestUtils</a></li>
            
                <li><a href="..&#x2F;classes/Hop.User.html">Hop.User</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/Cache.html">Cache</a></li>
            
                <li><a href="..&#x2F;modules/CodeGenerator.html">CodeGenerator</a></li>
            
                <li><a href="..&#x2F;modules/Event.html">Event</a></li>
            
                <li><a href="..&#x2F;modules/Hop.html">Hop</a></li>
            
                <li><a href="..&#x2F;modules/Job.html">Job</a></li>
            
                <li><a href="..&#x2F;modules/Test.html">Test</a></li>
            
                <li><a href="..&#x2F;modules/User.html">User</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib&#x2F;event.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;**
	@module Hop
	@submodule Event
**&#x2F;
var Hop = require(&#x27;.&#x2F;api&#x27;);
var uuid = require(&#x27;node-uuid&#x27;);

if(!Array.remove){
		Array.remove = function(array,from, to) {
			var rest = array.slice((to || from) + 1 || array.length);
			array.length = from &lt; 0 ? array.length + from : from;
			return array.push.apply(array, rest);
		};
}



Hop.Event={};
Hop.Event.sockets={};

Hop.Event.Channels=[];


Hop.Event.Channel = function(channel){
	this.channel=channel;
	this.regexp = new RegExp(this.channel.replace(&#x2F;:([^\&#x2F;]+)&#x2F;g,&quot;([^\&#x2F;]+)&quot;));
	this.params = this.channel.match(&#x2F;:([^\&#x2F;]+)&#x2F;g)||[];
	this.params = this.params.map(function(i){
		return i.replace(&#x2F;^:&#x2F;,&quot;&quot;);
	});
	this.subscribers=[];
	Hop.Event.Channels.push(this);
}

Hop.Event.Channel.create=function(channelPath){
	for(var i in Hop.Event.Channels){
		var channel = Hop.Event.Channels[i];
		if(channel.channel == channelPath)
			return channel;
	}	
	return new Hop.Event.Channel(channelPath);
}

Hop.Event.Channel.prototype.toString=function(){
	return { channel: this.channel, subscribers: this.subscribers.length };
}

Hop.Event.Channel.prototype.matches=function(path){
	var match = path.match(this.regexp);
	if(match){
		match.shift();

		var input={};

		for(var i in this.params){
			input[this.params[i]] = match[i];
		}
		return input;
	} else { 
		return null;
	}
}

Hop.Event.Channel.prototype.unsubscribeByKey=function(key){
	Hop.log(&quot;Subscribers&quot;,this.subscribers);
	for(var i in this.subscribers){
		var subscriber = this.subscribers[i];
		if(subscriber.key==key){
			Hop.log(&quot;Attempting to delete:&quot;,i);
			Array.remove(this.subscribers,i);
			this.unsubscribeByKey(key);
		}
	}	
}

Hop.Event.Channel.prototype.unsubscribe=function(id){
	for(var i in this.subscribers){
		var subscriber = this.subscribers[i];
		if(subscriber.id==id){
			Array.remove(this.subscribers,i);
		}
	}	
}

Hop.Event.Channel.prototype.subscribe=function(url,key,onComplete){
	var m = this.matches(url);
	if(m){

		var id = uuid(); 

		this.subscribers.push({
			id: id,
			key: key,
			url:url,
		});

		return onComplete(null,id);			
	} else {
		return false;
	}	
}

Hop.Event.Channel.prototype.notify=function(url,message,source,onComplete){
	onComplete=onComplete||function(){};
	var m = this.matches(url);
	var self=this;
	if(m){
		Hop.log(&quot;Notifying channel&quot;,this.toString());
		for(var i in this.subscribers){
			var subscriber = this.subscribers[i];

			if(subscriber.url==url){
				try {
					var req = {
							channel: self.channel,
							url: url,
							source: source,
							key: subscriber.key,
							id: subscriber.id,
							params: m
					}
					Hop.log(&quot;Notifying subsscriber&quot;,req,message);	
					(function(req,message){
					Hop.Event.Channel.notify(req,message,function(err,res){
						if(res==0){
							Hop.log(&quot;Deleting all subscriptions for key: &quot;,req.key);
							self.unsubscribeByKey(req.key);	
						} else {
							Hop.log(&quot;There are listeners&quot;,res);
						}
						&#x2F;&#x2F;FIXME This needs to keep track of the IDs to unsubscribe
					});	
					})(req,message);
				} catch(e){
					Hop.warn(e);
				}
			}	
		}
		return true;			
	} else {
		return false;
	}	
}

Hop.Event.Channel.Listeners={};

Hop.Event.Channel.removeListener=function(key,index){
	Hop.log(&quot;Removing&quot;,key,index);
	if(Hop.Event.Channel.Listeners[key]){
		var listeners = Hop.Event.Channel.Listeners[key];

		Array.remove(listeners.callbacks,index);
	}
}

Hop.Event.Channel.notify=function(req,message,onComplete){
	var badIDs=[];
	Hop.log(&quot;LISTENERS&quot;,Hop.Event.Channel.Listeners);
	if(Hop.Event.Channel.Listeners[req.key]){
		var listeners = Hop.Event.Channel.Listeners[req.key];
		var k = listeners.callbacks.length;
		var notify=function(){
			if(k&gt;0){
				k--;	
				Hop.log(&quot;Notifying listener&quot;,listeners.callbacks[k].toString());
				try {
					listeners.callbacks[k](req,message,function(err,res){
						if(err || res===false){
							Hop.Event.Channel.removeListener(req.key,k);	
						}
						notify();
					});	
				} catch(e){
					Hop.error(e);
					Hop.Event.Channel.removeListener(req.key,k);	
				}
			} else {
				var numListeners = listeners.callbacks.length;
				if(numListeners==0){
					delete Hop.Event.Channel.Listeners[req.key];
				}
				return onComplete(null,numListeners);
			}
		}	
		notify(); 
	} else {
		return onComplete(null,0);
	}	
}

Hop.Event.Channel.listen=function(key,onNotify){
	if(!Hop.Event.Channel.Listeners[key]){
		Hop.Event.Channel.Listeners[key]={ callbacks:[], when: new Date().getTime() };
	}
	Hop.log(&quot;Adding call back&quot;);
	Hop.Event.Channel.Listeners[key].callbacks.push(onNotify);
}

Hop.Event.Channel.find=function(path){
	for(var i in Hop.Event.Channels){
		var channel = Hop.Event.Channels[i];
		if(channel.matches(path)){
			return channel;
		}
	}
	return null;
}

Hop.EventHelper={};

Hop.EventHelper.getKey=function(input,onComplete,req){
	if(req.session){
		if(!req.session.eventKey){ 
			req.session.eventKey=uuid();
		}
		return onComplete(null,req.session.eventKey);
	} else {
		return onComplete(&quot;Session support is required for event support&quot;);
	}
}

Hop.EventHelper.listen=function(input,onComplete,req){
	Hop.log(&quot;CHANNELS&quot;,typeof input.channels);
	if(input.channels){
		if(input.channels instanceof String){
			try { 
				input.channels = JSON.parse(input.channels);
			} catch(e){
	
			}
		}
		if(!input.channels instanceof Array)
				return onComplete(&quot;Invalid type for channels, array is expected&quot;);
	} else {
		input.channels = [];
	}

	var subscribe=function(){
		if(input.channels.length&gt;0){
			var channelPath = input.channels.pop();
			var channel = Hop.Event.Channel.find(channelPath);
			if(channel){
				Hop.log(input,&quot;Found channel&quot;,channel.toString());
				&#x2F;&#x2F;We need to see if this listener can actually subscribe to the channel
				channel.subscribe(channelPath,input.key,function(){});
			}
			process.nextTick(subscribe);
		} else {
			Hop.log(&quot;Listinging on key&quot;,input.key);
			Hop.Event.Channel.listen(input.key,function(req,message,onDone){
				Hop.log(&quot;Attempting to respond to listener&quot;);
				try {
					onComplete(null,{ channel: req.channel, url: req.url, message:message, source: req.source});
				} catch(e){
					return onDone(e,false);
				}
				return onDone(null,false);
			});
		}
	}
	subscribe();

};


Hop.EventHelper.subscribe=function(input,onComplete,req){
	Hop.log(&quot;SUBSCRIBE&quot;);
	&#x2F;&#x2F;Find a matching channel	
	var channel = Hop.Event.Channel.find(input.channel);
	if(channel){
		Hop.log(input,&quot;Found channel&quot;,channel.toString());
		&#x2F;&#x2F;We need to see if this listener can actually subscribe to the channel
		channel.subscribe(input.channel,input.key,onComplete);
	} else return onComplete(null,null);
}

Hop.EventHelper.listChannels=function(input,onComplete,req){
	var channels = [];
	for(var i in Hop.Event.Channels){
		var channel = Hop.Event.Channels[i];
		channels.push(channel.toString());
	}
	return onComplete(null,channels);
}

Hop.EventHelper.unsubscribe=function(input,onComplete,req){
	var channel = Hop.Event.Channel.find(input.channel);
	if(channel){
		var res = channel.unsubscribe(input.id);
		return onComplete(null,res);
	} else return onComplete(null,null);
}

Hop.EventHelper.emit=function(req,input,onComplete){
	var source = { method: &quot;Event.emit&quot; };
	if(req.session &amp;&amp; req.session.user &amp;&amp; req.session.user.name){
		source.user=req.session.user.name;
	}	
	var message = { channel: input.channel, message: input.message, source: source };
	
	&#x2F;&#x2F;FIXME should try to force addition of user to event data 
	Hop.Event.Bus.emit(message);
	return onComplete(null,true);		
}

Hop.defineClass(&quot;Hop.Event&quot;,Hop.EventHelper,function(api){
	api.get(&quot;getKey&quot;,&quot;&#x2F;event&#x2F;key&quot;);
	api.get(&quot;listen&quot;,&quot;&#x2F;event&#x2F;listen&quot;).demand(&quot;key&quot;).optional(&quot;channels&quot;).noCache();
	api.post(&quot;emit&quot;,&quot;&#x2F;event&#x2F;&quot;).demand(&quot;channel&quot;).demand(&quot;message&quot;);
	api.post(&quot;subscribe&quot;,&quot;&#x2F;event&#x2F;channel&quot;).demand(&quot;channel&quot;).demand(&quot;key&quot;);
	api.del(&quot;unsubscribe&quot;,&quot;&#x2F;event&#x2F;channel&quot;).demand(&quot;key&quot;).demand(&quot;id&quot;);
	api.get(&quot;listChannels&quot;,&quot;&#x2F;event&#x2F;channel&quot;);
});


Hop.EventEmitter=function(channel,source){
	this.channel=channel;
	this.source = source
}

Hop.EventEmitter.prototype.emit=function(message){
	&#x2F;&#x2F;FIXME should try to force addition of user to event data 
	Hop.Event.Bus.emit({ channel: this.channel,message: message, source:this.source},function(){});
};

Hop.EventEmitter.resolvePath=function(path,req,input){
	var request=req;
	return path.replace(&#x2F;:([^\&#x2F;]+)&#x2F;g,function(m,s){
		if(s){
			try {
				with(input){
					var v = eval(s);
					if(v==undefined){
						throw &quot;Undefined value found in cache path: &quot;+s;
					}
					return v.toString();
				}
			} catch(e){
				throw &quot;Error in cache path: &quot;+s+&quot; is &quot;+e;
			}
		}
	});
}


&#x2F;**
Emit an event prior to calling this method

* The channel will have variables provided by the input parameters
	substituted into it.

@param {string} channel The channel to emit the event on
@param {function} onEmit The function which determines what is emitted
@param {object} onEmit.req The Exbeforess&#x2F;HTTP request object
@param {object} onEmit.input The input object

@example
	api.post(&quot;send&quot;,&quot;&#x2F;message&#x2F;send&quot;).emitBefore(&quot;&#x2F;user&#x2F;:to&quot;,function(req,input){
		&#x2F;&#x2F;Emit an event to the specified channel
		this.emit({msg: input.msg, from: input.from});
	}).demand(&quot;msg&quot;).demand(&quot;from&quot;).demand(&quot;to&quot;);


@method emitBefore
@for Hop.Method
@chainable
**&#x2F;
Hop.Method.prototype.emitBefore=function(channel,onEmit){

	Hop.Event.Channel.create(channel);

	var self=this;
	self.addPreCall(function(req,input,onComplete){
		var path = Hop.EventEmitter.resolvePath(channel,req,input);
	
		var source = { method: self.getMethod() };
		if(req.session &amp;&amp; req.session.user &amp;&amp; req.session.user.name){
			source.user=req.session.user.name;
		}	
		var emitter = new Hop.EventEmitter(path,source);
		try {
			onEmit.apply(emitter,[req,input]);
		} catch(e){
			Hop.error(&quot;Error while calling event emitter on method &quot;+self.className+&quot;.&quot;+self.name+&quot; &quot;+e.toString());
		}		

		onComplete();	
		
	},&quot;event&quot;);
	return this;
}


&#x2F;**
Emit an event after calling this method

* The channel will have variables provided by the input parameters
	substituted into it.

@param {string} channel The channel to emit the event on
@param {function} onEmit The function which determines what is emitted
@param {object} onEmit.req The Express&#x2F;HTTP request object
@param {object} onEmit.input The input object
@param {object} onEmit.err The error resulting from calling the method 
@param {object} onEmit.result The result of calling the method 

@example
	api.post(&quot;processFile&quot;,&quot;&#x2F;process&#x2F;&quot;).emitAfter(&quot;&#x2F;user&#x2F;:userId&quot;,function(req,input,err,result){
		&#x2F;&#x2F;Emit an event to the specified channel
		this.emit({err: err, result:result});
	}).demand(&quot;userId&quot;);


@method emitAfter
@for Hop.Method
@users Hop.Cache
@chainable
**&#x2F;
Hop.Method.prototype.emitAfter=function(channel,onEmit){

	new Hop.Event.Channel(channel);

	var self=this;
	self.addPostCall(function(req,input,err,result,onComplete){
		var path = Hop.EventEmitter.resolvePath(channel,req,input);
	
		var source = { method: self.getMethod() };
		if(req.session &amp;&amp; req.session.user &amp;&amp; req.session.user.name){
			source.user=req.session.user.name;
		}	
		var emitter = new Hop.EventEmitter(path,source);
		try {
			onEmit.apply(emitter,[req,input,err,result]);
		} catch(e){
			Hop.error(&quot;Error while calling event emitter on method &quot;+self.className+&quot;.&quot;+self.name+&quot; &quot;+e.toString());
		}		

		onComplete();	
		
	},&quot;event&quot;);
	return this;
}

&#x2F;**
Alias to emitAFter

@method emit
@for Hop.Method
@chainable
**&#x2F;
Hop.Method.prototype.emit=Hop.Method.prototype.emitAfter;

Hop.Event.Bus={};

Hop.addAfterTemplate(&quot;JavaScript&quot;,&quot;event&#x2F;preJSHop.comb&quot;);


Hop.Event.Bus.localEmit=function(message,onComplete){
	var channel = Hop.Event.Channel.find(message.channel);
	if(channel){
		Hop.log(&quot;localEmit&quot;,message);
		channel.notify(message.channel,message.message,message.source);
	}	
}

Hop.Event.Bus.emit=function(message,onComplete){

}


&#x2F;* 
Hop.defineChannel(&quot;&#x2F;user&#x2F;:userID&#x2F;messages&quot;,function(c){
	c.onConnect(function(req,input,onAllowConnect){
		if(req.session.user.name==input.userID || req.session.user.userID=input.userID){
			return onAllowConnect(true);
		} else return onAllowConnect(false);
	});
});
*&#x2F;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
