<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/express.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Hop.html">Hop</a></li>
            
                <li><a href="../classes/Hop.CodeGenerator.html">Hop.CodeGenerator</a></li>
            
                <li><a href="../classes/Hop.Method.html">Hop.Method</a></li>
            
                <li><a href="../classes/Hop.Object.html">Hop.Object</a></li>
            
                <li><a href="../classes/Hop.StubRequest.html">Hop.StubRequest</a></li>
            
                <li><a href="../classes/Hop.StubResponse.html">Hop.StubResponse</a></li>
            
                <li><a href="../classes/Hop.TestCase.html">Hop.TestCase</a></li>
            
                <li><a href="../classes/Hop.TestTask.html">Hop.TestTask</a></li>
            
                <li><a href="../classes/Hop.TestUtils.html">Hop.TestUtils</a></li>
            
                <li><a href="../classes/Hop.User.html">Hop.User</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Cache.html">Cache</a></li>
            
                <li><a href="../modules/CodeGenerator.html">CodeGenerator</a></li>
            
                <li><a href="../modules/Event.html">Event</a></li>
            
                <li><a href="../modules/Hop.html">Hop</a></li>
            
                <li><a href="../modules/Job.html">Job</a></li>
            
                <li><a href="../modules/Test.html">Test</a></li>
            
                <li><a href="../modules/User.html">User</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/express.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var Hop = require(&#x27;./api&#x27;);
var Fire = require(&#x27;fire-ts&#x27;);
var fs = require(&#x27;fs&#x27;);
var path = require(&#x27;path&#x27;);
var util = require(&#x27;hopjs-common&#x27;);


Hop.convertValue=function(value){
	if(value===null){
		return &quot;&quot;;
	} else if(value instanceof Array){
		var r = [];
		for(var i in value){
			r.push(Hop.convertValue(value[i]));
		}
		return r;
	} else if(typeof value==&quot;object&quot;){
		var r = {};
		for(var v in value){
			r[v]=Hop.convertValue(value[v]);
		}		
		return r;
	} else {
		if(value==null)
			return &quot;&quot;;
		else return value.toString();
	}
}

/**
Inserts the Hop calls into express

@param {string} basePath 
	the path which the Hop will hang off of
@param {object} app 
	the express app

@for Hop
@method apiHook
**/
Hop.apiHook=function(basePath,app,options){
	
	options=options||{};

	Hop.basePath=basePath;
	for(var objectName in Hop.Objects){
		var obj = Hop.Objects[objectName];
		for(var methodName in obj.methods){
			var method = obj.methods[methodName];
			Hop.log(method.method,method.getPath());	
			(function Hop_apiHook(obj,method){
							app[method.method](method.getPath(),function Hop_apiHook_hook(req,res){
								Hop.log(&quot;-&quot;,method.method,method.getPath());	

								var input = {};
						
								if(req.body._hopRedirect || req.query._hopRedirect){
									var redirect = req.body._hopRedirect || req.query._hopRedirect;
								}

								if(req.body._hopTemplate || req.query._hopTemplate){
									var template = req.body._hopTemplate || req.query._hopTemplate;
								}
	
								for(var paramName in method.params){
									var param = method.params[paramName];
									var value=undefined;
									if(method.method==&quot;get&quot; || method.method==&quot;del&quot; || method.method==&quot;delete&quot;)
										value = req.params[paramName] || req.query[paramName];
									else if(method.method==&quot;post&quot; || method.method==&quot;put&quot;) {
										if(req.files &amp;&amp; (param.demandFile || param.optionalFile)){
											value = req.files[paramName];	
										} else if(req.body){
											value = req.params[paramName] || req.body[paramName];
										} else {
											value = req.params[paramName];
											
										}
									}
									if(param.demand &amp;&amp; typeof value==&quot;undefined&quot;){
										return res.send(400,&quot;Missing parameter:&quot;+paramName);
									}
									//value=Hop.convertValue(value);
									input[paramName]=value;
								}
								//try {
									req._response = res;
									req.getResponse=function(){ return res; };
									var called=false;

	
									Hop.call(obj.name+&quot;.&quot;+method.name,input,function(err,result){
											var m = obj.name+&quot;.&quot;+method.name;
											if(called){
												Hop.logCall(m,&quot;warn&quot;,&quot;called onComplete twice&quot;);	
											} else {
												called=true;
												try {
													if(redirect)
														return res.redirect(redirect);
													if(template)
														return res.render(template,{ result: result, error: err, request: req});	

													if(err){
														err=obj.callOnError(method,req,input,err);
														res.send(500,err);
													} else {
														if(result instanceof Hop.File){
															result.send(res);
														} else if(result instanceof Hop.Template){
															result.send(res);
														} else {
															if(result===null || result===undefined){
																res.send(404,&quot;Not found&quot;);
															} else { 
																res.json(result);
															}
														}
													}
												} catch(e){
													Hop.error(e.stack);
												}
										}
									},req);
								/*
								} catch(e){
									res.send(500,e.toString()+&quot;\n&quot;+e.stack());	
								}*/
							});
			})(obj,method);
		}
	}
	var cwd = path.join(path.dirname(module.filename),&quot;../&quot;);
	Hop.docURL = util.webpath.join(basePath,&quot;/&quot;);
	app.get(util.webpath.join(basePath,&quot;/&quot;),function(req,res){
		var apiChecksum = (Hop.checksum());
		fs.readFile(path.join(cwd,&quot;static/doc.comb&quot;),function(err,data){
			try {
				var template = Fire.compile(data.toString());
				res.set(&#x27;Content-Type&#x27;, &#x27;text/html&#x27;);
				res.send(template({ Hop: Hop, _csrf: (req.session?req.session._csrf:undefined) }));
			} catch(e){
				Hop.error(&quot;Error parsing doc template&quot;,e.stack);
				res.send(500,&quot;Error:&quot;+e.toString());
			}
		});
	});
	Hop.apiURL = util.webpath.join(basePath,&quot;api.js&quot;);
	app.get(util.webpath.join(basePath,&quot;api.js&quot;),function(req,res){
		var apiChecksum = (Hop.checksum());
		if(req.get(&quot;If-Non-Match&quot;)==apiChecksum){
			return res.send(&quot;Not modified&quot;,304);
		}
		var file = path.join(cwd,&quot;static/api.comb&quot;);
		fs.readFile(file,function(err,data){
				try {
				var template = Fire.compile(data.toString());
			

				res.set(&#x27;Content-Type&#x27;, &#x27;application/javascript&#x27;);
				res.set(&#x27;Content-Type&#x27;, &#x27;text/html&#x27;);
				res.set(&quot;ETag&quot;,apiChecksum);	
				res.set(&quot;Hop-Checksum&quot;,apiChecksum);
			
				res.send(template({ Hop: Hop, Objects: Hop.Objects, Models: Hop.Models, _csrf: (req.session?req.session._csrf:null)}));
				} catch (e){
					Hop.error(&quot;Error parsing api template&quot;,e.stack);
					res.send(500,&quot;Error:&quot;+e.msg);
				}

		});
	});
	Hop.testURL=util.webpath.join(basePath,&quot;test.js&quot;);

	app.get(util.webpath.join(basePath,&quot;test.js&quot;),function(req,res){
		var apiChecksum = (Hop.checksum());
		if(req.get(&quot;If-Non-Match&quot;)==apiChecksum){
			return res.send(&quot;Not modified&quot;,304);
		}
		fs.readFile(path.join(cwd,&quot;static/test.comb&quot;),function(err,data){
			try { 
				var template = Fire.compile(data.toString());
				res.set(&#x27;Content-Type&#x27;, &#x27;application/javascript&#x27;);
				res.set(&quot;ETag&quot;,apiChecksum);	
				res.send(template(Hop));
			} catch(e){
				Hop.error(&quot;Error parsing test template&quot;,e.stack);
				res.send(500,&quot;Error:&quot;+e.toString());
			}
		});
	});
	app.get(util.webpath.join(basePath,&quot;/api.json&quot;),function(req,res){
		res.contentType(&quot;application/json&quot;);
		res.send(Hop.toJSON());
	});
	app.get(&quot;/_hopjs/&quot;,function(req,res){
		res.redirect(basePath);
	});
	app.get(&quot;/_hopjs/api.json&quot;,function(req,res){
		res.contentType(&quot;application/json&quot;);
		res.send(Hop.toJSON());
	});
	app.get(&quot;/_hopjs/apitest.json&quot;,function(req,res){
		res.contentType(&quot;application/json&quot;);
		res.send(JSON.stringify(Hop.TestCases));
	});
	app.get(&quot;/_hopjs/apitest.js&quot;,function(req,res){
		res.contentType(&quot;text/javascript&quot;);
		res.send(Hop.TestCase.toStandAlone());
	});
	app.get(&quot;/_hopjs/*&quot;,function(req,res){
		if(req.params[0].indexOf(&quot;..&quot;)!=-1)
			return res.send(404,&quot;Not found&quot;);
		var file = path.join(__dirname,&quot;../static/_hopjs&quot;,req.params[0]);

		if(/\.comb$/.test(file) || /\.html\.fts/.test(file)){
			Fire.parse(file,{},function(err,templ){
				if(err) return res.send(500,err.toString());
				if(req.query.name){
					res.send(req.query.name+&quot;=&quot;+templ.toString());
				} else {
					res.send(templ.toString());
				}
			});	
		} else {
			res.sendfile(file);
		}
	});
}

var cwd = path.join(path.dirname(module.filename),&quot;../&quot;);


/**
Render a template using the cumbustion template engine

@param {string} filename The filename of the template relative to the &quot;./static&quot; path
@param {object} input The inputs to the template

@for Hop
@method renderTemplate
**/
Hop.renderTemplate=function(filename,input){
	input=input||{};
	try {
		var file = path.join(cwd,&quot;static&quot;,filename);
		if(fs.existsSync(file)){
			var data = fs.readFileSync(file);
		} else {
			var data = fs.readFileSync(filename);
		}
		if(!data){
			return &quot;Invalid template specified:&quot;+filename;	
		}
		
		var _input={};
		for(var i in input){
			_input[i]=input[i];
		}
		_input.Hop=Hop;


		var template = Fire.compile(data.toString());
		return template;
	} catch(e){
		Hop.error(e);
		Hop.error(e.stack);
		return (file+&quot;:&quot;+e.toString());
	}
}

module.exports=Hop;


    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
